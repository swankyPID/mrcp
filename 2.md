# unimrcp源码阅读

目录结构
```
|-- source code
	|-- build/			编译工具
	|-- conf/			配置目录
		|-- unimrcpserver.xml		服务端配置，包括服务ip/端口/asr、tts引擎参数等等
		|-- unimrcpclient.xml		umc配置，包括客户端ip/端口等等
		|-- client-profiles/		umc测试服务配置，每个文件代表一种服务
			|-- unimrcp.xml				默认配置，包括服务ip/端口等等
		|-- umc-scenarios/			umc行为配置
	|-- data/			测试数据
	|-- libs/			基础类库，包括apache runtime/mrcp、sip、rtp协议文本解析等等
	|-- modules/		同上
	|-- platforms/		应用
	|-- plugins/		server端资源插件，支持语音识别/语音合成/录音器/语音认证
	|-- tools/			工具
```

首先我们找到main函数

![](mrcp-2.png)

## 一.启动server加载配置。

![](mrcp-3.png)
```
static apt_bool_t options_load(server_options_t *options, int argc, const char * const *argv, apr_pool_t *pool)
```
通过root下的几个主要字节点分别进行处理，对应处理函数如下：

unimrcp_server_properties_load ： properties加载

unimrcp_server_components_load ：componets加载，包括各个功能的plugin

unimrcp_server_settings_load ： 

unimrcp_server_profiles_load ：

unimrcp_server_misc_load ：

## 二.消息处理链路

系统启动时会为每个plugin启动一个任务处理线程，循环函数在：
```
apt_consumer_task.c：apt_consumer_task_run()
```
具体消息处理在 ：
```
apt_task.c : apt_task_msg_process()  ——》apt_task_vtable_t.process_msg() ——》会调用到每个plugin定时时注册的函数
```
MRCP消息解析 ： 
```
apt_text_message.c:apt_message_parser_run()
```








